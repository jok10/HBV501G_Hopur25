<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Playlist Manager</title>
    <style>
        body { font-family: sans-serif; margin: 2rem; }
        h1, h2 { margin-bottom: 0.3rem; }
        .box { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
        label { display: block; margin-top: 0.3rem; }
        input[type=text], input[type=password], input[type=url], input[type=number] {
            width: 100%; max-width: 400px;
        }
        button { margin-top: 0.5rem; }
        .error { color: darkred; margin-top: 0.5rem; }
        .success { color: darkgreen; margin-top: 0.5rem; }
        .playlist { margin: 0.5rem 0; }
        .track { margin: 0.5rem 0; }
    </style>
</head>
<body>
<h1>Playlist Manager</h1>

<div id="auth-section" class="box">
    <h2>Authentication</h2>

    <div id="auth-status">Not logged in</div>

    <h3>Register</h3>
    <label>
        Username:
        <input id="reg-username" type="text">
    </label>
    <label>
        Email:
        <input id="reg-email" type="text">
    </label>
    <label>
        Password:
        <input id="reg-password" type="password">
    </label>
    <button id="btn-register">Register</button>

    <h3>Login</h3>
    <label>
        Username:
        <input id="login-username" type="text">
    </label>
    <label>
        Password:
        <input id="login-password" type="password">
    </label>
    <button id="btn-login">Login</button>
    <button id="btn-logout">Logout</button>

    <div id="auth-message" class=""></div>
</div>

<div id="playlist-section" class="box" style="display:none;">
    <h2>My Playlists</h2>

    <h3>Create Playlist</h3>
    <label>
        Name:
        <input id="pl-name" type="text">
    </label>
    <label>
        Public:
        <input id="pl-public" type="checkbox" checked>
    </label>
    <label>
        Image URL (optional):
        <input id="pl-image" type="text">
    </label>
    <button id="btn-create-playlist">Create Playlist</button>

    <h3>Your Playlists</h3>
    <div id="my-playlists"></div>
</div>

<div id="tracks-section" class="box">
    <h2>Tracks</h2>

    <h3>Create Track (with external audio URL)</h3>
    <label>
        Title:
        <input id="tr-title" type="text">
    </label>
    <label>
        Artist:
        <input id="tr-artist" type="text">
    </label>
    <label>
        Album:
        <input id="tr-album" type="text">
    </label>
    <label>
        Duration (ms):
        <input id="tr-duration" type="number" value="600000">
    </label>
    <label>
        Audio URL:
        <input id="tr-fileurl" type="url" placeholder="https://example.com/song.mp3">
    </label>
    <label>
        MIME type:
        <input id="tr-mime" type="text" value="audio/mpeg">
    </label>
    <button id="btn-create-track">Create Track</button>

    <h3>All Tracks (page 0, size 10)</h3>
    <div id="tracks-list"></div>
</div>

<script>
    let currentUserId = null;
    let currentToken = null; // we don't strictly need it for session-based auth

    function setAuthMessage(msg, isError = false) {
        const el = document.getElementById("auth-message");
        el.textContent = msg || "";
        el.className = isError ? "error" : "success";
    }

    function updateAuthStatus() {
        const statusEl = document.getElementById("auth-status");
        if (currentUserId) {
            statusEl.textContent = "Logged in as user #" + currentUserId;
            document.getElementById("playlist-section").style.display = "block";
        } else {
            statusEl.textContent = "Not logged in";
            document.getElementById("playlist-section").style.display = "none";
        }
    }

    async function checkMe() {
        try {
            const res = await fetch("/api/auth/me");
            if (!res.ok) {
                currentUserId = null;
                updateAuthStatus();
                return;
            }
            const data = await res.json();
            if (data.authenticated) {
                currentUserId = data.userId;
            } else {
                currentUserId = null;
            }
            updateAuthStatus();
            if (currentUserId) {
                await loadMyPlaylists();
            }
        } catch (e) {
            console.error(e);
        }
    }

    async function loadMyPlaylists() {
        if (!currentUserId) return;
        const res = await fetch("/api/playlists/mine");
        if (!res.ok) {
            document.getElementById("my-playlists").textContent = "Could not load playlists.";
            return;
        }
        const data = await res.json();
        const container = document.getElementById("my-playlists");
        container.innerHTML = "";
        data.forEach(pl => {
            const div = document.createElement("div");
            div.className = "playlist";
            div.innerHTML = `
                <strong>${pl.name}</strong> (ID: ${pl.playlistId}, public: ${pl.public})<br>
                Created at: ${pl.createdAt || ""}<br>
                <button onclick="viewPlaylistTracks(${pl.playlistId})">View Tracks</button>
            `;
            container.appendChild(div);
        });
    }

    async function viewPlaylistTracks(playlistId) {
        const res = await fetch(`/api/playlists/${playlistId}/tracks`);
        if (!res.ok) {
            alert("Could not load tracks for playlist " + playlistId);
            return;
        }
        const tracks = await res.json();
        alert("Tracks for playlist " + playlistId + ":\n" +
            tracks.map(t => `#${t.position}: trackId=${t.trackId}, start=${t.startMs}, end=${t.endMs}`).join("\n"));
    }

    async function loadTracks() {
        const res = await fetch("/api/tracks?page=0&size=10");
        if (!res.ok) {
            document.getElementById("tracks-list").textContent = "Could not load tracks.";
            return;
        }
        const data = await res.json();
        const container = document.getElementById("tracks-list");
        container.innerHTML = "";
        data.content.forEach(t => {
            const div = document.createElement("div");
            div.className = "track";
            div.innerHTML = `
                <strong>${t.title}</strong> by ${t.artist} (ID: ${t.trackId})<br>
                <audio controls src="/api/tracks/${t.trackId}/stream"></audio><br>
                <label>
                    Playlist ID:
                    <input type="number" min="1" value="" id="pl-for-track-${t.trackId}">
                </label>
                <button onclick="addTrackToPlaylist(${t.trackId})">Add to playlist</button>
                <hr>
            `;
            container.appendChild(div);
        });
    }

    async function addTrackToPlaylist(trackId) {
        const input = document.getElementById("pl-for-track-" + trackId);
        const playlistId = input.value;
        if (!playlistId) {
            alert("Enter a playlist ID first.");
            return;
        }
        const res = await fetch(`/api/playlists/${playlistId}/tracks?trackId=${trackId}`, {
            method: "POST"
        });
        if (!res.ok) {
            alert("Failed to add track to playlist (HTTP " + res.status + ")");
            return;
        }
        const data = await res.json();
        alert("Added track to playlist. PlaylistTrack id: " + data.playlistTrackId);
    }

    // ---- Button wiring ----
    document.getElementById("btn-register").onclick = async () => {
        const username = document.getElementById("reg-username").value;
        const email = document.getElementById("reg-email").value;
        const password = document.getElementById("reg-password").value;

        setAuthMessage("");

        const res = await fetch("/api/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, email, password })
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch (_) { data = null; }

        if (!res.ok) {
            setAuthMessage(data?.error || "Registration failed", true);
            return;
        }

        currentUserId = data.userId;
        updateAuthStatus();
        setAuthMessage("Registered and logged in as " + data.username);
        await loadMyPlaylists();
    };

    document.getElementById("btn-login").onclick = async () => {
        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;

        setAuthMessage("");

        const res = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch (_) { data = null; }

        if (!res.ok) {
            setAuthMessage(data?.error || "Login failed", true);
            currentUserId = null;
            updateAuthStatus();
            return;
        }

        currentUserId = data.userId;
        currentToken = data.token;
        updateAuthStatus();
        setAuthMessage("Logged in as " + data.username);
        await loadMyPlaylists();
    };

    document.getElementById("btn-logout").onclick = async () => {
        await fetch("/api/auth/logout", { method: "POST" });
        currentUserId = null;
        currentToken = null;
        updateAuthStatus();
        setAuthMessage("Logged out.");
        document.getElementById("my-playlists").innerHTML = "";
    };

    document.getElementById("btn-create-playlist").onclick = async () => {
        if (!currentUserId) {
            alert("You must be logged in to create a playlist.");
            return;
        }
        const name = document.getElementById("pl-name").value;
        const isPublic = document.getElementById("pl-public").checked;
        const imageUrl = document.getElementById("pl-image").value || null;

        const res = await fetch("/api/playlists", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, isPublic, imageUrl })
        });

        if (!res.ok) {
            alert("Failed to create playlist (HTTP " + res.status + ")");
            return;
        }

        const data = await res.json();
        alert("Created playlist with ID " + data.playlistId);
        await loadMyPlaylists();
    };

    document.getElementById("btn-create-track").onclick = async () => {
        const title = document.getElementById("tr-title").value;
        const artist = document.getElementById("tr-artist").value;
        const album = document.getElementById("tr-album").value;
        const durationMs = Number(document.getElementById("tr-duration").value) || 0;
        const fileUrl = document.getElementById("tr-fileurl").value;
        const mimeType = document.getElementById("tr-mime").value;

        const res = await fetch("/api/tracks", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, artist, album, durationMs, fileUrl, mimeType })
        });

        if (!res.ok) {
            alert("Failed to create track (HTTP " + res.status + ")");
            return;
        }

        const data = await res.json();
        alert("Created track with ID " + data.trackId);
        await loadTracks();
    };

    // initial load
    (async () => {
        await checkMe();   // see if session already has a user
        await loadTracks();

    })();
</script>
</body>
</html>
