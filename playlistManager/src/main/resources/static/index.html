<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Playlist Manager</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 1rem 2rem 3rem;
            background: #111;
            color: #eee;
        }

        h1, h2, h3 {
            margin-top: 1.4rem;
        }

        a { color: #8cf; }

        .layout {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }

        .card {
            background: #1b1b1b;
            border-radius: 6px;
            padding: 1rem 1.2rem;
            margin-bottom: 1rem;
            border: 1px solid #333;
        }

        label {
            display: block;
            margin: 0.3rem 0 0.1rem;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.35rem 0.4rem;
            border-radius: 4px;
            border: 1px solid #555;
            background: #111;
            color: #eee;
            box-sizing: border-box;
        }

        input[type="checkbox"] {
            margin-right: 0.3rem;
        }

        button {
            margin-top: 0.6rem;
            padding: 0.35rem 0.9rem;
            border-radius: 4px;
            border: 1px solid #666;
            background: #2b2b2b;
            color: #eee;
            cursor: pointer;
        }

        button:hover {
            background: #3b3b3b;
        }

        .small {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .track-row {
            border-top: 1px solid #333;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        audio {
            margin: 0.3rem 0;
            width: 100%;
        }

        .error {
            color: #ff8585;
        }

        .ok {
            color: #9f9;
        }

        .pill {
            display: inline-block;
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            background: #262626;
            font-size: 0.75rem;
            margin-left: 0.4rem;
        }

        .auth-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .auth-row > div {
            flex: 1 1 260px;
        }

        .playlist-image {
            max-width: 100%;
            border-radius: 4px;
            margin-top: 0.4rem;
        }
    </style>
</head>
<body>
<h1>Playlist Manager</h1>

<div class="card">
    <h2>Login / Register</h2>
    <!-- paragraph with 'These endpoints assume you have...' has been removed -->
    <div class="auth-row">
        <!-- Register -->
        <div>
            <h3>Register</h3>
            <form id="register-form">
                <label>Username
                    <input type="text" id="reg-username" required>
                </label>
                <label>Email
                    <input type="text" id="reg-email">
                </label>
                <label>Password
                    <input type="password" id="reg-password" required>
                </label>
                <button type="submit">Register</button>
            </form>
        </div>

        <!-- Login -->
        <div>
            <h3>Login</h3>
            <form id="login-form">
                <label>Username
                    <input type="text" id="login-username" required>
                </label>
                <label>Password
                    <input type="password" id="login-password" required>
                </label>
                <button type="submit">Login</button>
            </form>
            <button id="logout-button" type="button">Logout</button>
        </div>
    </div>
    <div id="auth-status" class="small"></div>
</div>

<p class="small">
    Make sure you are logged in (session-based) before using the playlist features.
</p>

<div class="layout">
    <!-- LEFT: Tracks & creation -->
    <div>
        <!-- Create Track -->
        <div class="card">
            <h2>Create Track</h2>
            <form id="create-track-form">
                <label>Title
                    <input type="text" id="track-title" required>
                </label>
                <label>Artist
                    <input type="text" id="track-artist" required>
                </label>
                <label>Album
                    <input type="text" id="track-album">
                </label>
                <label>Duration (ms)
                    <input type="number" id="track-duration" value="600000" min="1000" step="1000">
                </label>
                <label>Audio URL (direct .mp3/.ogg/.wav…)
                    <input type="text" id="track-url" required>
                </label>
                <label>MIME type (e.g. <code>audio/mpeg</code>, <code>audio/ogg</code>)
                    <input type="text" id="track-mime" value="audio/mpeg" required>
                </label>
                <button type="submit">Create track</button>
                <div id="create-track-status" class="small"></div>
            </form>
        </div>

        <!-- All Tracks -->
        <div class="card">
            <h2>All Tracks</h2>
            <div id="tracks-list" class="small">Loading tracks…</div>
        </div>
    </div>

    <!-- RIGHT: Playlists -->
    <div>
        <!-- Create Playlist -->
        <div class="card">
            <h2>Create Playlist</h2>
            <form id="create-playlist-form">
                <label>Name
                    <input type="text" id="playlist-name" required>
                </label>
                <label>Image URL (optional)
                    <input type="text" id="playlist-image">
                </label>
                <button type="submit">Create playlist</button>
                <div id="create-playlist-status" class="small"></div>
            </form>
        </div>

        <!-- My Playlists -->
        <div class="card">
            <h2>My Playlists</h2>
            <div id="my-playlists" class="small">Loading playlists…</div>
        </div>
    </div>
</div>

<script>
    // --- global-ish state ---
    let allTracks = [];      // list of tracks from /api/tracks
    let myPlaylists = [];    // list from /api/playlists/mine
    let isLoggedIn = false;  // NEW: track login state on the frontend

    // -------- helper fetch with JSON ----------
    async function apiFetch(url, options = {}) {
        const opts = Object.assign({
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin"
        }, options);
        const res = await fetch(url, opts);
        if (!res.ok) {
            const text = await res.text().catch(() => "");
            throw new Error("HTTP " + res.status + " " + res.statusText + " – " + text);
        }
        const ct = res.headers.get("Content-Type") || "";
        if (ct.includes("application/json")) {
            return res.json();
        }
        return null;
    }

    // -------- auth --------
    async function registerUser(e) {
        e.preventDefault();
        const status = document.getElementById("auth-status");
        status.textContent = "";

        const body = {
            username: document.getElementById("reg-username").value.trim(),
            email: document.getElementById("reg-email").value.trim(),
            password: document.getElementById("reg-password").value
        };

        try {
            await apiFetch("/api/auth/register", {
                method: "POST",
                body: JSON.stringify(body)
            });
            status.innerHTML = `<span class="ok">Registered. You can now log in.</span>`;
            document.getElementById("register-form").reset();
        } catch (e2) {
            console.error(e2);
            status.innerHTML = `<span class="error">Register failed: ${e2.message}</span>`;
        }
    }

    async function loginUser(e) {
        e.preventDefault();
        const status = document.getElementById("auth-status");
        status.textContent = "";

        const username = document.getElementById("login-username").value.trim();
        const body = {
            username: username,
            password: document.getElementById("login-password").value
        };

        try {
            await apiFetch("/api/auth/login", {
                method: "POST",
                body: JSON.stringify(body)
            });
            isLoggedIn = true;  // NEW
            status.innerHTML = `<span class="ok">Logged in as ${username}.</span>`;
            document.getElementById("login-form").reset();
            await loadMyPlaylists();
        } catch (e2) {
            console.error(e2);
            isLoggedIn = false; // login failed
            status.innerHTML = `<span class="error">Login failed: ${e2.message}</span>`;
        }
    }

    async function logoutUser() {
        const status = document.getElementById("auth-status");
        try {
            await apiFetch("/api/auth/logout", { method: "POST" });
        } catch (e) {
            console.error(e);
            // even if logout endpoint is missing, just clear UI
        }
        isLoggedIn = false; // NEW
        status.innerHTML = `<span class="ok">Logged out.</span>`;
        myPlaylists = [];
        refreshPlaylistSelectOptions();
        document.getElementById("my-playlists").textContent = "You are logged out.";
    }

    // -------- tracks --------
    async function loadTracks() {
        const container = document.getElementById("tracks-list");
        try {
            const page = await apiFetch("/api/tracks?page=0&size=50", {method: "GET"});
            allTracks = page.content || [];
            if (allTracks.length === 0) {
                container.textContent = "No tracks in the system yet.";
                return;
            }

            container.innerHTML = "";
            allTracks.forEach(t => {
                const div = document.createElement("div");
                div.className = "track-row";

                const title = document.createElement("div");
                title.innerHTML =
                    `<strong>${t.title}</strong> by ${t.artist} <span class="pill">ID: ${t.trackId}</span>`;
                div.appendChild(title);

                const audio = document.createElement("audio");
                audio.controls = true;
                // plain full-track playback on the left side
                audio.src = `/api/tracks/${t.trackId}/stream`;
                div.appendChild(audio);

                // Add-to-playlist controls
                const controls = document.createElement("div");
                controls.className = "small";

                const select = document.createElement("select");
                select.className = "playlist-select";
                controls.appendChild(select);

                const btn = document.createElement("button");
                btn.type = "button";
                btn.textContent = "Add to playlist";
                btn.onclick = () => addTrackToSelectedPlaylist(t.trackId, select);
                controls.appendChild(btn);

                div.appendChild(controls);
                container.appendChild(div);
            });

            refreshPlaylistSelectOptions();
        } catch (e) {
            console.error(e);
            container.innerHTML = `<span class="error">Failed to load tracks: ${e.message}</span>`;
        }
    }

    async function createTrack(e) {
        e.preventDefault();
        const status = document.getElementById("create-track-status");
        status.textContent = "";

        // NEW: block creating tracks when not logged in
        if (!isLoggedIn) {
            status.innerHTML = `<span class="error">You must be logged in to create tracks.</span>`;
            return;
        }

        const body = {
            title: document.getElementById("track-title").value.trim(),
            artist: document.getElementById("track-artist").value.trim(),
            album: document.getElementById("track-album").value.trim() || null,
            durationMs: parseInt(document.getElementById("track-duration").value, 10) || 0,
            fileUrl: document.getElementById("track-url").value.trim(),
            mimeType: document.getElementById("track-mime").value.trim()
        };

        try {
            await apiFetch("/api/tracks", {
                method: "POST",
                body: JSON.stringify(body)
            });
            status.innerHTML = `<span class="ok">Track created.</span>`;
            document.getElementById("create-track-form").reset();
            document.getElementById("track-duration").value = "180000";
            await loadTracks();
        } catch (e2) {
            console.error(e2);
            status.innerHTML = `<span class="error">Failed: ${e2.message}</span>`;
        }
    }

    // -------- playlists --------
    async function loadMyPlaylists() {
        const container = document.getElementById("my-playlists");
        try {
            const res = await fetch("/api/playlists/mine", {credentials: "same-origin"});
            if (res.status === 401 || res.status === 403) {
                isLoggedIn = false; // NEW: backend says not logged in
                container.innerHTML =
                    `<span class="error">You are not logged in or session expired. Log in, then reload this page.</span>`;
                myPlaylists = [];
                refreshPlaylistSelectOptions();
                return;
            }
            if (!res.ok) {
                throw new Error("HTTP " + res.status + " " + res.statusText);
            }
            isLoggedIn = true; // NEW: request worked, so session is live
            myPlaylists = await res.json();
            refreshPlaylistSelectOptions();

            if (myPlaylists.length === 0) {
                container.textContent = "You have no playlists yet.";
                return;
            }

            container.innerHTML = "";
            for (const p of myPlaylists) {
                const card = document.createElement("div");
                card.className = "track-row";

                const header = document.createElement("div");
                header.innerHTML =
                    `<strong>${p.name}</strong> <span class="pill">ID: ${p.playlistId}</span>` +
                    (p.public ? `<span class="pill">public</span>` : `<span class="pill">private</span>`);
                card.appendChild(header);

                const created = document.createElement("div");
                created.className = "small";
                if (p.createdAt) {
                    created.textContent = "Created: " + p.createdAt;
                }
                card.appendChild(created);

                // show playlist image (if any)
                if (p.imageUrl) {
                    const img = document.createElement("img");
                    img.src = p.imageUrl;
                    img.alt = p.name || "Playlist image";
                    img.className = "playlist-image";
                    card.appendChild(img);
                }

                // buttons: show tracks + delete playlist
                const btnRow = document.createElement("div");
                btnRow.className = "small";
                btnRow.style.marginTop = "0.4rem";

                const tracksDiv = document.createElement("div");
                tracksDiv.className = "small";
                tracksDiv.style.marginTop = "0.5rem";
                tracksDiv.textContent = " ";
                card.appendChild(tracksDiv);

                const btnLoad = document.createElement("button");
                btnLoad.type = "button";
                btnLoad.textContent = "Show tracks";
                btnLoad.onclick = () => loadPlaylistTracks(p.playlistId, tracksDiv);
                btnRow.appendChild(btnLoad);

                const btnDelete = document.createElement("button");
                btnDelete.type = "button";
                btnDelete.style.marginLeft = "0.5rem";
                btnDelete.textContent = "Delete playlist";
                btnDelete.onclick = () => deletePlaylist(p.playlistId);
                btnRow.appendChild(btnDelete);

                card.appendChild(btnRow);

                container.appendChild(card);
            }
        } catch (e) {
            console.error(e);
            container.innerHTML = `<span class="error">Failed to load playlists: ${e.message}</span>`;
        }
    }

    async function createPlaylist(e) {
        e.preventDefault();
        const status = document.getElementById("create-playlist-status");
        status.textContent = "";

        const body = {
            name: document.getElementById("playlist-name").value.trim(),
            public: false,  // playlists default to private
            imageUrl: document.getElementById("playlist-image").value.trim() || null
        };

        try {
            await apiFetch("/api/playlists", {
                method: "POST",
                body: JSON.stringify(body)
            });
            status.innerHTML = `<span class="ok">Playlist created.</span>`;
            document.getElementById("create-playlist-form").reset();
            await loadMyPlaylists();
        } catch (e2) {
            console.error(e2);
            status.innerHTML = `<span class="error">Failed: ${e2.message}</span>`;
        }
    }

    async function addTrackToSelectedPlaylist(trackId, selectEl) {
        const playlistId = selectEl.value;
        if (!playlistId) {
            alert("Choose a playlist first.");
            return;
        }
        try {
            await apiFetch(`/api/playlists/${playlistId}/tracks?trackId=${trackId}`, {
                method: "POST"
            });
            alert(`Track ${trackId} added to playlist ${playlistId}.`);
            // reload the playlist list; user can then click "Show tracks" again
            await loadMyPlaylists();
        } catch (e) {
            console.error(e);
            alert("Failed to add: " + e.message);
        }
    }

    // delete playlist
    async function deletePlaylist(playlistId) {
        if (!confirm(`Really delete playlist ${playlistId}?`)) return;
        try {
            await apiFetch(`/api/playlists/${playlistId}`, { method: "DELETE" });
            await loadMyPlaylists();
        } catch (e) {
            console.error(e);
            alert("Failed to delete playlist: " + e.message);
        }
    }

    // remove track from playlist
    async function deletePlaylistTrack(playlistId, playlistTrackId, container) {
        if (!confirm(`Remove track ${playlistTrackId} from playlist ${playlistId}?`)) return;
        try {
            await apiFetch(`/api/playlists/${playlistId}/tracks/${playlistTrackId}`, { method: "DELETE" });
            await loadPlaylistTracks(playlistId, container);
        } catch (e) {
            console.error(e);
            alert("Failed to remove track: " + e.message);
        }
    }

    // remove track from playlist stays as-is, this goes AFTER deletePlaylistTrack()
    async function loadPlaylistTracks(playlistId, container) {
        container.textContent = "Loading…";
        try {
            const res = await apiFetch(`/api/playlists/${playlistId}/tracks`, {method: "GET"});
            if (!Array.isArray(res) || res.length === 0) {
                container.textContent = "No tracks in this playlist yet.";
                return;
            }
            container.innerHTML = "";

            const audios = [];

            res.forEach(pt => {
                const meta = allTracks.find(t => t.trackId === pt.trackId);
                const div = document.createElement("div");
                div.style.borderTop = "1px solid #333";
                div.style.paddingTop = "0.4rem";
                div.style.marginTop = "0.4rem";

                const label = document.createElement("div");
                const title = meta ? `${meta.title} by ${meta.artist}` : `Track ID ${pt.trackId}`;
                label.innerHTML = `#${pt.position + 1}: <strong>${title}</strong>
                <span class="pill">playlistTrackId: ${pt.playlistTrackId}</span>`;
                div.appendChild(label);

                const audio = document.createElement("audio");
                audio.controls = true;
                audio.src = `/api/tracks/${pt.trackId}/stream`;

                // --- marker playback handling ---
                const hasStart = pt.startMs != null;
                const hasEnd   = pt.endMs != null && pt.endMs > 0;
                const startSec = hasStart ? (pt.startMs / 1000) : 0;
                const endSec   = hasEnd   ? (pt.endMs   / 1000) : 0;

                if (hasStart || hasEnd) {
                    audio.addEventListener("loadedmetadata", function () {
                        if (hasStart && this.currentTime < startSec) {
                            this.currentTime = startSec;
                        }
                    });

                    audio.addEventListener("timeupdate", function () {
                        if (hasStart && this.currentTime < startSec - 0.05) {
                            this.currentTime = startSec;
                        }
                        if (hasEnd && this.currentTime > endSec + 0.05) {
                            this.pause();
                            // Pretend the track naturally finished so the "ended" handler fires
                            this.dispatchEvent(new Event("ended"));
                        }
                    });

                }

                div.appendChild(audio);
                audios.push(audio);

                // --- marker UI: inputs + 'use current position' + save ---
                const markerDiv = document.createElement("div");
                markerDiv.className = "small";
                markerDiv.style.marginTop = "0.3rem";

                // Start ms input
                const startLabel = document.createElement("label");
                startLabel.style.marginRight = "0.4rem";
                startLabel.textContent = "Start (ms): ";
                const startInput = document.createElement("input");
                startInput.type = "number";
                startInput.min = "0";
                startInput.step = "100";
                startInput.style.width = "6rem";
                startInput.value = (pt.startMs != null ? pt.startMs : 0);
                startLabel.appendChild(startInput);
                markerDiv.appendChild(startLabel);

                const btnSetStart = document.createElement("button");
                btnSetStart.type = "button";
                btnSetStart.textContent = "From current";
                btnSetStart.onclick = () => {
                    startInput.value = Math.floor(audio.currentTime * 1000);
                };
                markerDiv.appendChild(btnSetStart);

                // End ms input
                const endLabel = document.createElement("label");
                endLabel.style.marginLeft = "0.6rem";
                endLabel.style.marginRight = "0.4rem";
                endLabel.textContent = "End (ms): ";
                const endInput = document.createElement("input");
                endInput.type = "number";
                endInput.min = "0";
                endInput.step = "100";
                endInput.style.width = "6rem";
                endInput.value = (pt.endMs != null ? pt.endMs : 0);
                endLabel.appendChild(endInput);
                markerDiv.appendChild(endLabel);

                const btnSetEnd = document.createElement("button");
                btnSetEnd.type = "button";
                btnSetEnd.textContent = "From current";
                btnSetEnd.onclick = () => {
                    endInput.value = Math.floor(audio.currentTime * 1000);
                };
                markerDiv.appendChild(btnSetEnd);

                // Save markers button
                const btnSaveMarkers = document.createElement("button");
                btnSaveMarkers.type = "button";
                btnSaveMarkers.style.marginLeft = "0.6rem";
                btnSaveMarkers.textContent = "Save markers";
                btnSaveMarkers.onclick = async () => {
                    const startVal = parseInt(startInput.value, 10) || 0;
                    const endVal   = parseInt(endInput.value, 10)   || 0;

                    try {
                        await apiFetch(`/api/playlists/${playlistId}/tracks/${pt.playlistTrackId}/markers`, {
                            method: "PUT",
                            body: JSON.stringify({
                                startMs: startVal,
                                endMs: endVal
                            })
                        });
                        alert("Markers saved.");
                        // reload this playlist to re-bind playback handlers with new markers
                        await loadPlaylistTracks(playlistId, container);
                    } catch (err) {
                        console.error(err);
                        alert("Failed to save markers: " + err.message);
                    }
                };
                markerDiv.appendChild(btnSaveMarkers);

                div.appendChild(markerDiv);

                // remove-from-playlist button
                const btnRemove = document.createElement("button");
                btnRemove.type = "button";
                btnRemove.className = "small";
                btnRemove.style.marginTop = "0.3rem";
                btnRemove.textContent = "Remove from playlist";
                btnRemove.onclick = () => deletePlaylistTrack(playlistId, pt.playlistTrackId, container);
                div.appendChild(btnRemove);

                container.appendChild(div);
            });

            // sequential playback: when one ends, start the next
            audios.forEach((audioEl, idx) => {
                audioEl.addEventListener("ended", () => {
                    const next = audios[idx + 1];
                    if (next) {
                        next.play();
                    }
                });
            });
        } catch (e) {
            console.error(e);
            container.innerHTML = `<span class="error">Failed to load tracks: ${e.message}</span>`;
        }
    }


    // Fill all "playlist-select" elements with options from myPlaylists
    function refreshPlaylistSelectOptions() {
        const selects = document.querySelectorAll("select.playlist-select");
        selects.forEach(sel => {
            const current = sel.value;
            sel.innerHTML = "";
            const optEmpty = document.createElement("option");
            optEmpty.value = "";
            optEmpty.textContent = "-- choose playlist --";
            sel.appendChild(optEmpty);

            myPlaylists.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.playlistId;
                opt.textContent = `${p.name} (ID: ${p.playlistId})`;
                sel.appendChild(opt);
            });

            if (current) {
                sel.value = current;
            }
        });
    }

    // -------- wire up events & initial load --------
    document.getElementById("register-form")
        .addEventListener("submit", registerUser);
    document.getElementById("login-form")
        .addEventListener("submit", loginUser);
    document.getElementById("logout-button")
        .addEventListener("click", logoutUser);

    document.getElementById("create-track-form")
        .addEventListener("submit", createTrack);
    document.getElementById("create-playlist-form")
        .addEventListener("submit", createPlaylist);

    // Initial data fetch
    loadTracks();
    loadMyPlaylists();
</script>

</body>
</html>
